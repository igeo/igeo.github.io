<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>A Science Bowl Timer and Scorekeeper</title>
  <script>
    var halfTime = null;
    var questionTime = null;
    var isBonusTimer = false;
    var halfTimer, buzzerSound, fiveSecondsSound, halfTimerSound;

    function init() {
      halfTime = null;
      questionTime = null;
      isBonusTimer = false;
      halfTimer = document.getElementById("halfSeconds");
      buzzerSound = document.getElementById('wrongBuzzer_audio');
      fiveSecondsSound = document.getElementById('fiveSeconds_audio');
      halfTimerSound = document.getElementById('halfTimer_audio');

      const state = loadState();
      if (state) {
        document.getElementById("teamAscore").value = state.teamAscore || 0;
        document.getElementById("teamBscore").value = state.teamBscore || 0;
        document.getElementById("halfSeconds").value = state.halfSeconds || 480;
        document.getElementById("halfSecondsDisp").value = state.halfSecondsDisp || secondsInMinutes(480);
        document.getElementById("questionSeconds").value = state.questionSeconds || 0;
        isBonusTimer = !!state.isBonusTimer;
        document.getElementById("log").innerHTML = state.log || "";
        document.getElementById("clockDiv").style.backgroundColor = state.clockColor || "white";

        if (state.halfTimerRunning) {
          startTimer();
        }
        if (state.questionTimerRunning) {
          // Restart question timer interval
          if (questionTime != null) window.clearInterval(questionTime);
          questionTime = window.setInterval(decreaseQtimer, 1000);
        }
        return;
      }

      document.getElementById("teamAscore").value = 0;
      document.getElementById("teamBscore").value = 0;

      halfTimer.value = 480;
      document.getElementById("halfSecondsDisp").value = secondsInMinutes(halfTimer.value);
      document.getElementById("questionSeconds").value = 0;

      var logS = "Log of score changes will be kept here, just in case.<br> <br> Start of match.  Good luck teams!<br>";
      document.getElementById("log").innerHTML = logS;
      console.log(logS);
      window.scrollTo(0, 0);
    }

    function saveState() {
      const state = {
        teamAscore: document.getElementById("teamAscore").value,
        teamBscore: document.getElementById("teamBscore").value,
        halfSeconds: document.getElementById("halfSeconds").value,
        halfSecondsDisp: document.getElementById("halfSecondsDisp").value,
        questionSeconds: document.getElementById("questionSeconds").value,
        isBonusTimer: isBonusTimer,
        halfTimerRunning: halfTime !== null,
        questionTimerRunning: questionTime !== null,
        log: document.getElementById("log").innerHTML,
        clockColor: document.getElementById("clockDiv").style.backgroundColor
      };
      localStorage.setItem('nsb_scorekeeper_state', JSON.stringify(state));
    }

    function loadState() {
      const saved = localStorage.getItem('nsb_scorekeeper_state');
      if (!saved) return null;

      try {
        return JSON.parse(saved);
      } catch (e) {
        console.error("Error loading state:", e);
        return null;
      }
    }

    function newMatch() {
      if (confirm("Are you sure you want to start a new match?")) {
        var scoreA = document.getElementById("teamAscore").value;
        var scoreB = document.getElementById("teamBscore").value;
        var timestamp = formatTimestamp(new Date());
        var finalLog = timestamp + " - Match Ended. Final Score: Team A: " + scoreA + " - Team B: " + scoreB + "<br>";
        var separator = "<hr style='border-top: 3px solid #000; margin-top: 10px; margin-bottom: 10px;'>";
        var currentLog = document.getElementById("log").innerHTML;
        var newLog = separator + finalLog + currentLog;

        const newState = {
          teamAscore: 0,
          teamBscore: 0,
          halfSeconds: 480,
          halfSecondsDisp: secondsInMinutes(480),
          questionSeconds: 0,
          isBonusTimer: false,
          halfTimerRunning: false,
          questionTimerRunning: false,
          log: newLog,
          clockColor: "white"
        };
        localStorage.setItem('nsb_scorekeeper_state', JSON.stringify(newState));
        location.reload();
      }
    }

    function cleanLog() {
      if (confirm("Are you sure you want to clear the log?")) {
        document.getElementById("log").innerHTML = "";
        saveState();
      }
    }

    function secondsInMinutes(secs) {
      var min = Math.floor(secs / 60.0);
      var s = secs % 60;
      if (s < 10) s = "0" + s;
      var disp = min + ":" + s;
      return disp;
    }

    function formatTimestamp(date) {
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      const HH = String(date.getHours()).padStart(2, '0');
      const MM = String(date.getMinutes()).padStart(2, '0');
      const SS = String(date.getSeconds()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd} ${HH}:${MM}:${SS}`;
    }

    function addScore(team, amount) {
      var scoreElement = document.getElementById("team" + team + "score");
      scoreElement.value = parseInt(scoreElement.value) + parseInt(amount);

      const timestamp = formatTimestamp(new Date());
      var logS = timestamp + " - Score for team " + team + " changed by " + amount + "<br>";

      // Prepend the new log, keeping the newest at the top
      var currentLog = document.getElementById("log").innerHTML;
      document.getElementById("log").innerHTML = logS + currentLog;

      console.log(logS);
      saveState();
      window.scrollTo(0, 0);
    }

    function decreaseHalfTimer() {
      halfTimer = document.getElementById("halfSeconds");
      if (parseInt(halfTimer.value) > 0)
        halfTimer.value = parseInt(halfTimer.value) - 1;

      if (parseInt(halfTimer.value) <= 0) {
        window.clearInterval(halfTime);
        halfTimerSound.play();
        document.getElementById("clockDiv").style.backgroundColor = "red";
      }

      document.getElementById("halfSecondsDisp").value = secondsInMinutes(halfTimer.value);
      saveState();
    }

    function minutesToSeconds(s) {
      var A = s.split(":");
      var secs = parseInt(A[0]) * 60 + parseInt(A[1]);
      return secs;
    }

    function startTimer() {
      if (halfTime != null)
        window.clearInterval(halfTime);
      document.getElementById("halfSeconds").value = minutesToSeconds(document.getElementById("halfSecondsDisp").value);
      halfTime = window.setInterval(decreaseHalfTimer, 1000);
      document.getElementById("clockDiv").style.backgroundColor = "white";
      saveState();
    }

    function pauseTimer() {
      if (halfTime != null)
        window.clearInterval(halfTime);
      saveState();
    }

    function resetTimer() {
      if (halfTime != null) window.clearInterval(halfTime);
      document.getElementById("halfSeconds").value = "480";
      document.getElementById("halfSecondsDisp").value = secondsInMinutes(480);
      document.getElementById("clockDiv").style.backgroundColor = "white";
      saveState();
    }



    function decreaseQtimer() {
      var questionTimer = document.getElementById("questionSeconds");
      if (parseInt(questionTimer.value) > 0)
        questionTimer.value = parseInt(questionTimer.value) - 1;

      if (parseInt(questionTimer.value) <= 0) {
        window.clearInterval(questionTime);
        buzzerSound.play();
        document.getElementById("clockDiv").style.backgroundColor = "red";
      }

      if (isBonusTimer && parseInt(questionTimer.value) == 5) {
        document.getElementById("clockDiv").style.backgroundColor = "orange";
        fiveSecondsSound.play();
      }
      saveState();
    }

    function startTossup() {
      isBonusTimer = false;
      document.getElementById("questionSeconds").value = "5";
      if (questionTime != null)
        window.clearInterval(questionTime);
      questionTime = window.setInterval(decreaseQtimer, 1000);
      document.getElementById("clockDiv").style.backgroundColor = "white";
      saveState();
    }

    function startBonus() {
      isBonusTimer = true;
      document.getElementById("questionSeconds").value = "20";
      if (questionTime != null)
        window.clearInterval(questionTime);
      questionTime = window.setInterval(decreaseQtimer, 1000);
      document.getElementById("clockDiv").style.backgroundColor = "white";
      saveState();
    }

    function clearQtimer() {
      isBonusTimer = false;
      document.getElementById("questionSeconds").value = "0";
      if (questionTime != null)
        window.clearInterval(questionTime);
      document.getElementById("clockDiv").style.backgroundColor = "white";
      saveState();
    }
  </script>

  <style>
    div,
    h1 {
      text-align: center;
    }

    h1 {
      font-size: 150%;
    }

    button {
      height: 100px;
      font-size: 120%;
    }

    button.add {
      background-color: #ccffcc;
    }

    button.remove {
      background-color: #ffcccc;
    }

    input {
      font-size: 600%;
      font-weight: bold;
    }

    button,
    input {
      vertical-align: middle;
    }

    div.team {
      float: left;
      border: solid black 2px;
      margin: 10px;
      padding: 10px;
    }

    div.clock {
      border: solid black 2px;
      margin: 10px;
      padding: 10px;
    }
  </style>
</head>

<body onload='init();'>

  <div class="clock" id="clockDiv">
    <h1>NSB Clock and Scorekeeper</h1>
    <div style="float:left; padding-right: 30px">
      <p style="text-align:right">Half timer (m:ss)</p>
      <input type="hidden" id="halfSeconds" />
      <input style="width:260px;text-align:right" type="text" id="halfSecondsDisp" class="timer" />
      <button type="button" onclick="startTimer();" id="startTimer">Start</button>
      <button type="button" onclick="pauseTimer();" id="pauseTimer">Pause</button>
      <button type="button" onclick="resetTimer();" id="resetTimer">Reset</button>
      <button type="button" onclick="newMatch();" id="newMatch"
        style="margin-left: 10px; background-color: #f44336; color: white;">New Match</button>
    </div>

    <div style="float:left">
      <p style="text-align:right">Question timer (seconds)</p>
      <input style="width:150px;text-align:right" type="text" id="questionSeconds" class="timer" />
      <button type="button" onclick="startTossup();" id="startTossup">Tossup: 5s</button>
      <button type="button" onclick="startBonus();" id="startBonus">Bonus: 20s</button>
      <button type="button" onclick="clearQtimer();" id="clearQtimer">Clear</button>
    </div>

    <p style="clear:both"></p>

  </div>

  <div style="text-align:center;margin:auto">

    <div class="team">
      <h1>Team A</h1>
      <div style="float:left;margin-right:20px">
        <p class="score" style="text-align:right"> <input style="width:200px;text-align:right" type="text" readonly
            id="teamAscore" class="score" value="0" /></p>
      </div>
      <div style="float:left">
        <table>
          <tr>
            <td>Add</td>
            <td><button type="button" class="add" onclick="addScore('A',4);">Toss up: 4</button></td>
            <td><button type="button" class="add" onclick="addScore('A',10);">Bonus: 10</button></td>
          </tr>
          <tr>
            <td>Remove</td>
            <td><button type="button" class="remove" onclick="addScore('A',-4);">Toss up: 4</button></td>
            <td><button type="button" class="remove" onclick="addScore('A',-10);">Bonus: 10</button></td>
          </tr>
        </table>
      </div>
    </div>

    <div class="team">
      <h1>Team B</h1>
      <div style="float:left;margin-right:20px">
        <p class="score" style="text-align:right"> <input style="width:200px;text-align:right" type="text" readonly
            id="teamBscore" class="score" value="0" /></p>
      </div>
      <div style="float:left">
        <table>
          <tr>
            <td>Add</td>
            <td><button type="button" class="add" onclick="addScore('B',4);">Toss up: 4</button></td>
            <td><button type="button" class="add" onclick="addScore('B',10);">Bonus: 10</button></td>
          </tr>

          <tr>
            <td>Remove</td>
            <td><button type="button" class="remove" onclick="addScore('B',-4);">Toss up: 4</button></td>
            <td><button type="button" class="remove" onclick="addScore('B',-10);">Bonus: 10</button></td>
          </tr>
        </table>
      </div>
    </div>

  </div>

  <p style="clear:both"> </p>
  <hr>

  <h1>About this page</h1>
  <p>This page is a simple webpage that science bowl teams can
    use during practice. It should be self-explanatory to
    anyone who does science bowl or quiz bowl...</p>


  <div style="text-align:center;">
    <button type="button" onclick="cleanLog();" style="height: auto; font-size: 1em; padding: 5px 10px;">Clear
      Log</button>
  </div>
  <p id="log">
  </p>

  <audio id="fiveSeconds_audio" preload="auto">
    <source type="audio/mpeg" src="five_seconds.mp3" />
  </audio>
  <audio id="wrongBuzzer_audio" preload="auto">
    <source id="wrongBuzzer_mp3" type="audio/mpeg" src="time.mp3" />
  </audio>
  <audio id="halfTimer_audio" preload="auto">
    <source type="audio/mpeg" src="the_end.mp3" />
  </audio>


  <div style="text-align:center; padding: 20px; font-size: 0.9em; color: #666;">
    <p>Based on <a href="https://cs.indstate.edu/~jkinne/kids/scienceBowlTimer.html">A Science Bowl Timer and
        Scorekeeper</a> orignally created by Jeff Kinne.</p>
  </div>
</body>

</html>